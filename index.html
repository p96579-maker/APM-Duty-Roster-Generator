<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<title>APM Duty Roster Generator — v27-es5e</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --fg:#111; --muted:#666; --border:#ddd; --bg:#fff; --primary:#0b5cff; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,'PingFang HK','Noto Sans CJK HK',sans-serif; margin: 12px; color:var(--fg); background:var(--bg); }
  h1 { text-align:center; margin:6px 0 2px; font-size: clamp(18px, 5vw, 28px); }
  .ver { text-align:center; font-size:12px; color:var(--muted); margin-bottom:8px; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; margin:8px auto 12px; }
  .controls label { font-weight:600; }
  .chip { display:inline-flex; align-items:center; gap:4px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; }
  .controls input[type="date"]{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:16px; }
  button { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#f7f7f7; font-size:16px; }
  button.primary { border-color: var(--primary); background: var(--primary); color:#fff; }
  button:disabled { opacity:.5; }
  .availability { border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:12px; }
  .availability h2 { font-size:16px; margin:0 0 8px; }
  .role-group { margin:8px 0; }
  .role-group-title { display:block; font-weight:700; margin-bottom:6px; }
  .pillbox { display:flex; flex-wrap:wrap; gap:8px 10px; }
  .pillbox label { border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:500; }
  .pillbox input[type="checkbox"]{ inline-size:18px; block-size:18px; vertical-align:middle; }
  .section-title { text-align:center; font-size: clamp(16px, 4.5vw, 24px); margin:12px 0; }
  .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:10px; border:1px solid var(--border); background:#fff; }
  table { border-collapse:collapse; min-width:720px; width:100%; }
  th, td { border:1px solid #000; padding:10px; text-align:center; white-space:nowrap; font-size:14px; }
  thead tr:nth-child(1) th { background:#f3f3f3; }
  .sticky-head thead th { position:sticky; top:0; background:#f3f3f3; z-index:2; }
</style>
</head>
<body>
  <h1>APM Duty Roster Generator</h1>
  <div class="ver">v27-es5e • 2025-11-12 06:12</div>

  <div class="controls">
    <span class="chip"><input type="radio" name="groupType" value="DAY" id="gday" checked><label for="gday">DAY 組</label></span>
    <span class="chip"><input type="radio" name="groupType" value="NIGHT" id="gnight"><label for="gnight">NIGHT 組</label></span>
    <label class="chip">開始日期：<input type="date" id="groupDate"></label>
    <button class="primary" id="generateBtn">Generate</button>
    <button id="downloadBtn" disabled>Download Excel</button>
  </div>

  <div class="availability" id="availCard">
    <h2>Staff Availability</h2>
    <div class="role-group">
      <span class="role-group-title">BCR:</span>
      <div class="pillbox" id="bcrBox"></div>
    </div>
    <div class="role-group">
      <span class="role-group-title">EH / WH / MF:</span>
      <div class="pillbox" id="ehwhmfBox"></div>
    </div>
    <div class="role-group">
      <span class="role-group-title">DRIVER:</span>
      <div class="pillbox" id="driverBox"></div>
    </div>
    <div class="role-group">
      <span class="role-group-title">CCR_CONTROLLER:</span>
      <div class="pillbox" id="controllerBox"></div>
    </div>
    <div class="role-group">
      <span class="role-group-title">PM_LEADER (DAY):</span>
      <div class="pillbox" id="pmLeaderBox"></div>
    </div>
    <div class="role-group">
      <span class="role-group-title">DAILY_LEADER (NIGHT):</span>
      <div class="pillbox" id="dailyLeaderBox"></div>
    </div>
  </div>

  <h2 class="section-title" id="resultTitle" style="display:none;"></h2>
  <div class="table-wrap sticky-head">
    <div id="resultContainer"></div>
  </div>

<script type="text/javascript">
// 名單
var BCR_LIST = ["YK LAU","KC CHAN","WH LO","PF HO","TF TAM","CL KWONG","MT CHU"];
var EH_WH_MF_LIST = ["WW NG","WH LO","PH LAO","TF TAM","YC WONG","PF HO","CL KWONG","YK LAU"];
var DRIVER_LIST = ["KC CHAN","YT SIU","MT CHU"];
var CONTROLLER_LIST = ["KC CHAN","YT SIU","WW NG","WH LO","PH LAO","CK YUEN","YC WONG"];
var PM_LEADER_LIST = ["WW NG","WH LO","PH LAO","YC WONG","PF HO","CL KWONG","YK LAU"];
var DAILY_LEADER_LIST = ["WW NG","WH LO","PH LAO","YC WONG","PF HO","KC CHAN","MT CHU","HL CHEUNG","CL KWONG","YK LAU"];

var CURRENT_OPTIONS = {};

function addDays(date, days){ var r=new Date(date); r.setDate(r.getDate()+days); return r; }
function fmt(date){ var y=date.getFullYear(), m=('0'+(date.getMonth()+1)).slice(-2), d=('0'+date.getDate()).slice(-2); return y+'-'+m+'-'+d; }
function shuffle(a){ var arr=a.slice(); for(var i=0;i<arr.length-1;i++){ var j=i+Math.floor(Math.random()*(arr.length-i)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
function buildTwoDaySequence(list, total){ var res=new Array(total); var idx=0, w=0; while(w<total){ var name=list[idx]; res[w]=name; if(w+1<total) res[w+1]=name; w+=2; idx=(idx+1)%list.length; } return res; }
function tableToAoA(tbl){ var aoa=[]; var trs=tbl.getElementsByTagName('tr'); for(var i=0;i<trs.length;i++){ var row=[]; var cells=trs[i].children; for(var j=0;j<cells.length;j++){ row.push(cells[j].innerText||cells[j].textContent); } aoa.push(row); } return aoa; }
function mkCheckboxes(id, list, group){ var c=document.getElementById(id); c.innerHTML=''; for(var i=0;i<list.length;i++){ var lab=document.createElement('label'); lab.style.userSelect='none'; lab.style.cursor='pointer'; var cb=document.createElement('input'); cb.type='checkbox'; cb.name=group; cb.value=list[i]; cb.checked=true; cb.style.marginRight='6px'; lab.appendChild(cb); lab.appendChild(document.createTextNode(list[i])); c.appendChild(lab); } }
function getSelected(group){ var arr=[]; var n=document.getElementsByName(group); for(var i=0;i<n.length;i++){ if(n[i].checked) arr.push(n[i].value); } return arr; }
function arrWithout(arr, bad){ var out=[], i; for(i=0;i<arr.length;i++){ if(arr[i]!==bad) out.push(arr[i]); } return out; }
function unique(arr){ var m={}, out=[], i; for(i=0;i<arr.length;i++){ if(!m[arr[i]]){ m[arr[i]]=1; out.push(arr[i]); } } return out; }

function makeEditable(table, headers){
  var rows=table.tBodies[0].rows;
  for(var r=0;r<rows.length;r++){
    (function(tr){
      for(var c=0;c<tr.cells.length;c++){
        (function(cell, role){
          if(!role || role==="DATE") return;
          cell.style.cursor="pointer";
          cell.onclick=function(){
            var opts=[], key;
            if(role==="DAILY_LEADER"){
              var dailyAvail = CURRENT_OPTIONS.DAILY_LEADER||[];
              // leader 可重覆，不需要避開已用；但放齊清單方便更改
              opts = dailyAvail.slice();
              // 把當晚 DRIVER / MF 放到最前（如在可用名單）
              var map = {}; for(var x=0;x<opts.length;x++){ map[opts[x]]=1; }
              var dTxt=(tr.cells[1].innerText||tr.cells[1].textContent||'').trim();
              var mfTxt=(tr.cells[2].innerText||tr.cells[2].textContent||'').trim();
              var front=[]; if(map[dTxt]) front.push(dTxt); if(map[mfTxt] && mfTxt!==dTxt) front.push(mfTxt);
              for(var k=0;k<opts.length;k++){ if(front.indexOf(opts[k])<0) front.push(opts[k]); }
              opts=front;
            }else{
              key = (role==="MF"||role==="WH"||role==="EH") ? "EHWHMF" : role;
              opts = CURRENT_OPTIONS[key]||[];
              // 不可與當日其他欄重覆
              var used2=[], j;
              for(j=0;j<tr.cells.length;j++){ var tt=(tr.cells[j].innerText||tr.cells[j].textContent||'').trim(); if(tt && tt!=="(空白)") used2.push(tt); }
              var filtered=[]; for(j=0;j<opts.length;j++){ if(used2.indexOf(opts[j])<0) filtered.push(opts[j]); }
              opts=filtered;
            }
            if(opts.length===0) return;
            var current=(cell.innerText||cell.textContent||'').trim();
            var sel=document.createElement('select'); var empty=document.createElement('option'); empty.value=''; empty.text='(空白)'; if(!current) empty.selected=true; sel.appendChild(empty);
            for(var q=0;q<opts.length;q++){ var op=document.createElement('option'); op.value=op.text=opts[q]; if(opts[q]===current) op.selected=true; sel.appendChild(op); }
            cell.innerHTML=''; cell.appendChild(sel); sel.focus();
            var finalize=function(){ cell.innerHTML=sel.value; };
            sel.onblur=finalize; sel.onchange=finalize;
          };
        })(rows[r].cells[c], headers[c]);
      }
    })(rows[r]);
  }
}

function generateRoster(){
  var container=document.getElementById("resultContainer");
  var title=document.getElementById("resultTitle");
  container.innerHTML=''; title.style.display="none"; title.innerText='';

  var groupType = (document.querySelector('input[name="groupType"]:checked')||{}).value || "DAY";
  var dateStr=document.getElementById("groupDate").value;
  if(!dateStr){ alert("請先選擇開始日期"); return; }
  var start=new Date(dateStr);

  var bcrList=getSelected("bcr");
  var ehwhmfList=getSelected("ehwhmf");
  var driverList=getSelected("driver");
  var controllerList=getSelected("controller");
  var pmLeaderList=getSelected("pmleader");
  var dailyLeaderAvail=getSelected("dailyleader");

  if(bcrList.length===0){ alert("BCR 沒有人可用"); return; }
  if(ehwhmfList.length<3){ alert("EH/WH/MF 少於 3 人"); return; }
  if(driverList.length===0){ alert("DRIVER 沒有人可用"); return; }
  if(groupType==="DAY" && pmLeaderList.length===0){ alert("DAY 需要 PM_LEADER"); return; }
  if(groupType==="NIGHT" && dailyLeaderAvail.length===0){ alert("NIGHT 需要最少一位可做 DAILY_LEADER 的人"); return; }

  var TOTAL=4;

  if(groupType==="DAY"){
    var end=addDays(start,3);
    var heads=["DATE","DRIVER","MF","WH","EH","BCR","PM_LEADER"];
    var tbl=document.createElement("table"); var thead=document.createElement("thead");
    var r1=document.createElement("tr"); var th=document.createElement("th"); th.colSpan=heads.length; th.innerText="DAY 組（"+fmt(start)+" 至 "+fmt(end)+"）"; r1.appendChild(th); thead.appendChild(r1);
    var r2=document.createElement("tr"); for(var i=0;i<heads.length;i++){ var h=document.createElement("th"); h.innerText=heads[i]; r2.appendChild(h);} thead.appendChild(r2);
    tbl.appendChild(thead); var tb=document.createElement("tbody"); tbl.appendChild(tb);

    var pm = pmLeaderList[Math.floor(Math.random()*pmLeaderList.length)];
    var bcrCandidates = arrWithout(bcrList, pm); if(bcrCandidates.length===0) bcrCandidates=bcrList.slice();
    var bcrSeq = buildTwoDaySequence(shuffle(bcrCandidates), TOTAL);
    var driverSeq = buildTwoDaySequence(shuffle(driverList), TOTAL); // DAY 亦保持連兩日

    var forbid={}, i; forbid[pm]=true; for(i=0;i<bcrSeq.length;i++){ forbid[bcrSeq[i]]=true; }
    var pool=[]; for(i=0;i<ehwhmfList.length;i++){ if(!forbid[ehwhmfList[i]]) pool.push(ehwhmfList[i]); }
    if(pool.length<3) pool=ehwhmfList.slice();
    var triple=shuffle(pool).slice(0,3);
    function rolesForDay(d){ var idx=d%3; var a=triple[idx], b=triple[(idx+1)%3], c=triple[(idx+2)%3]; return {EH:a, WH:b, MF:c}; }

    for(i=0;i<TOTAL;i++){ var roles=rolesForDay(i); var row=[fmt(addDays(start,i)), driverSeq[i], roles.MF, roles.WH, roles.EH, bcrSeq[i], pm]; var tr=document.createElement("tr"); for(var c=0;c<row.length;c++){ var td=document.createElement("td"); td.innerText=row[c]; tr.appendChild(td);} tb.appendChild(tr); }
    title.style.display="block"; title.innerText="DAY 排班"; container.appendChild(tbl); makeEditable(tbl, heads);
  } else {
    var i;
    function pickCCR(){ var arr=shuffle(controllerList); for(var a=0;a<arr.length;a++){ var cand=arr[a]; var okB=arrWithout(bcrList,cand).length>=1; var okD=arrWithout(driverList,cand).length>=1; var okE=arrWithout(ehwhmfList,cand).length>=3; if(okB&&okD&&okE) return cand; } return arr[0]; }
    var ccr = pickCCR();

    var bcrBase = arrWithout(bcrList, ccr); if(bcrBase.length===0) bcrBase=bcrList.slice();
    var bcrSeq = buildTwoDaySequence(shuffle(bcrBase), TOTAL);

    var triplePool = arrWithout(ehwhmfList, ccr);
    var triple = shuffle(triplePool).slice(0,3);
    if(triple.length<3){ triple = shuffle(ehwhmfList).slice(0,3); }
    function tripleForDay(d){ var idx=d%3; return [triple[idx], triple[(idx+1)%3], triple[(idx+2)%3]]; } // [EH, WH, MF]

    // DRIVER：連兩日 pair，並避開當晚已用人（CCR/EH/WH/MF/BCR）
    var driverBase = arrWithout(driverList, ccr); if(driverBase.length===0) driverBase=driverList.slice();
    driverBase = shuffle(driverBase);
    var nextIdx=0;
    function planDriverPair(startDay, blockedSet){
      // 循環找第一個不衝突的 candidate，回傳此人並把 day startDay 及 startDay+1 都用此人
      var tried=0, cand;
      while(tried < driverBase.length){
        cand = driverBase[nextIdx % driverBase.length]; nextIdx++;
        if(!blockedSet[cand]) return cand;
        tried++;
      }
      return driverBase[0]; // fallback
    }

    var end=addDays(start,3);
    var heads=["DATE","DRIVER","MF","WH","EH","BCR","CCR_CONTROLLER","DAILY_LEADER"];
    var tbl=document.createElement("table"); var thead=document.createElement("thead");
    var r1=document.createElement("tr"); var th=document.createElement("th"); th.colSpan=heads.length; th.innerText="NIGHT 組（"+fmt(start)+" 至 "+fmt(end)+"）"; r1.appendChild(th); thead.appendChild(r1);
    var r2=document.createElement("tr"); for(i=0;i<heads.length;i++){ var h=document.createElement("th"); h.innerText=heads[i]; r2.appendChild(h);} thead.appendChild(r2);
    tbl.appendChild(thead); var tb=document.createElement("tbody"); tbl.appendChild(tb);

    var driverPlan = new Array(TOTAL);

    for(i=0;i<TOTAL;i++){
      var EH_WH_MF = tripleForDay(i);
      var EHn = EH_WH_MF[0], WHn = EH_WH_MF[1], MFn = EH_WH_MF[2];

      var blocked = {}; blocked[ccr]=true; blocked[EHn]=true; blocked[WHn]=true; blocked[MFn]=true;

      var bcrToday = bcrSeq[i];
      if(blocked[bcrToday]){
        for(var bi=0; bi<bcrBase.length; bi++){ if(!blocked[bcrBase[bi]]){ bcrToday=bcrBase[bi]; break; } }
      }
      blocked[bcrToday]=true;

      // Driver pair logic
      if(driverPlan[i] == null){
        var cand = planDriverPair(i, blocked);
        driverPlan[i] = cand;
        if(i+1 < TOTAL) driverPlan[i+1] = cand; // make the pair
      }
      var drv = driverPlan[i];
      // 極端情況：pair 已定但撞名（例如翌日不同 blocked），臨時換另一位但同樣把 pair 改為新的人
      if(blocked[drv]){
        var tried=0, alt=drv;
        while(tried<driverBase.length && blocked[alt]){
          alt = driverBase[(nextIdx++) % driverBase.length];
          tried+=1;
        }
        drv = alt;
        driverPlan[i] = drv;
        if(i%2==0 && i+1<TOTAL) driverPlan[i+1] = drv;
        if(i%2==1) driverPlan[i-1] = drv; // 保持前一日同一人（成對）
      }
      blocked[drv]=true;

      // Daily leader 自動：優先 DRIVER，其次 MF，再其次任意可用名單第一個；可與其他欄重覆
      var leaderToday = "";
      if(DAILY_LEADER_LIST.indexOf(drv)>=0 && getSelected('dailyleader').indexOf(drv)>=0) leaderToday = drv;
      else if(DAILY_LEADER_LIST.indexOf(MFn)>=0 && getSelected('dailyleader').indexOf(MFn)>=0) leaderToday = MFn;
      else {
        var avail = getSelected('dailyleader');
        leaderToday = (avail[0]||"");
      }

      var row=[fmt(addDays(start,i)), drv, MFn, WHn, EHn, bcrToday, ccr, leaderToday];
      var tr=document.createElement("tr"); for(var c=0;c<row.length;c++){ var td=document.createElement("td"); td.innerText=row[c]; tr.appendChild(td);} tb.appendChild(tr);
    }

    title.style.display="block"; title.innerText="NIGHT 排班"; container.appendChild(tbl); makeEditable(tbl, heads);
  }

  CURRENT_OPTIONS = { DRIVER: driverList, EHWHMF: ehwhmfList, BCR: bcrList, PM_LEADER: pmLeaderList, CCR_CONTROLLER: controllerList, DAILY_LEADER: dailyLeaderAvail };
  document.getElementById("downloadBtn").disabled = false;
}

function downloadExcel(){ var wb=XLSX.utils.book_new(); var container=document.getElementById("resultContainer"); var tbl=container.querySelector("table"); if(!tbl){ alert("未有結果可匯出"); return; } var aoa=tableToAoA(tbl); var isDay=(document.getElementById("resultTitle").innerText||'').indexOf("DAY")>=0; var sheet=XLSX.utils.aoa_to_sheet(aoa); XLSX.utils.book_append_sheet(wb, sheet, isDay?"DAY":"NIGHT"); XLSX.writeFile(wb, "APM_duty_roster_one_group.xlsx"); }

(function init(){ mkCheckboxes("bcrBox", BCR_LIST, "bcr"); mkCheckboxes("ehwhmfBox", EH_WH_MF_LIST, "ehwhmf"); mkCheckboxes("driverBox", DRIVER_LIST, "driver"); mkCheckboxes("controllerBox", CONTROLLER_LIST, "controller"); mkCheckboxes("pmLeaderBox", PM_LEADER_LIST, "pmleader"); mkCheckboxes("dailyLeaderBox", DAILY_LEADER_LIST, "dailyleader"); document.getElementById("generateBtn").onclick=generateRoster; document.getElementById("downloadBtn").onclick=downloadExcel; })();
</script>
</body>
</html>
